<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link href="https://gavinw.me/swift-macos/rss.xml" rel="alternate" type="application/rss+xml" title="RSS">
    <link href="https://gavinw.me/swift-macos/styles.css" rel="stylesheet">
    <title>Swift macOS</title>
</head>
<body>
<div class="container">
    
<div class="row">
<div class="col">
    <h1>Particles</h1>
    
        <h6>November 12, 2022</h6>
    
    <hr>
    <p>This example uses Metal to draw particles (pixels) in a view. The particles move throughout the view based on their position and velocity. This example is inspired by the <a href="https://metalkit.org/2017/11/30/working-with-particles-in-metal-part-3/">Working with Particles in Metal part 3</a> article by Marius Horga. However, this example is implemented with SwiftUI for macOS whereas Marius' example runs in an Xcode playground.</p>
<p><img src="/swift-macos/img/metal-particles.png" style="max-width:400px;" alt="metal particles"></p>
<p>The main view and window is setup in the SwiftUI ContentView.</p>
<pre data-lang="swift" style="background-color:#2b303b;color:#c0c5ce;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#b48ead;">import </span><span>SwiftUI
</span><span>
</span><span style="color:#b48ead;">struct</span><span> ContentView: View {
</span><span>    </span><span style="color:#b48ead;">var</span><span> body: some View {
</span><span>        VStack {
</span><span>            MetalView()
</span><span>            Text(</span><span style="color:#a3be8c;">&quot;Metal particles ðŸ¤˜&quot;</span><span>)
</span><span>        }
</span><span>        .padding()
</span><span>        .frame(minWidth: </span><span style="color:#d08770;">400</span><span>, minHeight: </span><span style="color:#d08770;">300</span><span>)
</span><span>    }
</span><span>}
</span></code></pre>
<p>To implement Metal with SwiftUI, you can wrap the MTKView as an NSViewRepresentable which is depicted by the MetalView shown below. The Renderer handles drawing to the view. This approach is adopted from the Ray Wenderlich book <a href="https://www.raywenderlich.com/books/metal-by-tutorials">Metal by Tutorials</a>. A stepper is used to control the number of particles drawn in the view.</p>
<pre data-lang="swift" style="background-color:#2b303b;color:#c0c5ce;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#b48ead;">import </span><span>SwiftUI
</span><span style="color:#b48ead;">import </span><span>MetalKit
</span><span>
</span><span style="color:#b48ead;">struct</span><span> MetalView: View {
</span><span>
</span><span>    </span><span style="color:#b48ead;">@State private var</span><span> metalView = MTKView()
</span><span>    </span><span style="color:#b48ead;">@State private var</span><span> renderer: Renderer?
</span><span>    </span><span style="color:#b48ead;">@State private var</span><span> count: Int = </span><span style="color:#d08770;">5000
</span><span>
</span><span>    </span><span style="color:#b48ead;">var</span><span> body: some View {
</span><span>        VStack {
</span><span>            MetalViewRepresentable(metalView: $metalView)
</span><span>                .onAppear {
</span><span>                    renderer = Renderer(metalView: metalView)
</span><span>                }
</span><span>            Stepper(</span><span style="color:#a3be8c;">&quot;Particle count: </span><span>\(count)</span><span style="color:#a3be8c;">&quot;</span><span>, value: $count, </span><span style="color:#b48ead;">in</span><span>: </span><span style="color:#d08770;">5_000</span><span>...</span><span style="color:#d08770;">55_000</span><span>, step: </span><span style="color:#d08770;">10_000</span><span>)
</span><span>                .onChange(of: count) { newValue </span><span style="color:#b48ead;">in
</span><span>                    renderer?.particleCount = newValue
</span><span>                    renderer?.initializeBuffers()
</span><span>                }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">struct</span><span> MetalViewRepresentable: NSViewRepresentable {
</span><span>
</span><span>    </span><span style="color:#b48ead;">@Binding var</span><span> metalView: MTKView
</span><span>
</span><span>    </span><span style="color:#b48ead;">func </span><span>makeNSView(context: Context) -&gt; some NSView {
</span><span>        metalView
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">func </span><span>updateNSView(_ uiView: NSViewType, context: Context) { }
</span><span>}
</span></code></pre>
<p>The Renderer class initializes the Metal device, command queue, pipeline states, and shader functions. This class acts as the MTKViewDelegate to draw the particles in the view. The Particle struct is also defined in this file.</p>
<pre data-lang="swift" style="background-color:#2b303b;color:#c0c5ce;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="color:#b48ead;">import </span><span>MetalKit
</span><span>
</span><span style="color:#b48ead;">struct</span><span> Particle {
</span><span>    </span><span style="color:#b48ead;">var</span><span> color: SIMD4&lt;Float&gt;
</span><span>    </span><span style="color:#b48ead;">var</span><span> position: SIMD2&lt;Float&gt;
</span><span>    </span><span style="color:#b48ead;">var</span><span> velocity: SIMD2&lt;Float&gt;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">class</span><span> Renderer: NSObject {
</span><span>
</span><span>    </span><span style="color:#b48ead;">static var</span><span> device: MTLDevice!
</span><span>    </span><span style="color:#b48ead;">static var</span><span> commandQueue: MTLCommandQueue!
</span><span>
</span><span>    </span><span style="color:#b48ead;">var</span><span> clearState: MTLComputePipelineState!
</span><span>    </span><span style="color:#b48ead;">var</span><span> drawState: MTLComputePipelineState!
</span><span>
</span><span>    </span><span style="color:#b48ead;">var</span><span> particleBuffer: MTLBuffer!
</span><span>    </span><span style="color:#b48ead;">var</span><span> particleCount: Int = </span><span style="color:#d08770;">5000
</span><span>
</span><span>    </span><span style="color:#b48ead;">init</span><span>(metalView: MTKView) {
</span><span>
</span><span>        </span><span style="color:#b48ead;">super</span><span>.</span><span style="color:#b48ead;">init</span><span>()
</span><span>
</span><span>        </span><span style="color:#b48ead;">guard let</span><span> device = MTLCreateSystemDefaultDevice(),
</span><span>              </span><span style="color:#b48ead;">let</span><span> commandQueue = device.makeCommandQueue()
</span><span>        </span><span style="color:#b48ead;">else</span><span> {
</span><span>            fatalError(</span><span style="color:#a3be8c;">&quot;GPU not available&quot;</span><span>)
</span><span>        }
</span><span>
</span><span>        Renderer.device = device
</span><span>        Renderer.commandQueue = commandQueue
</span><span>
</span><span>        </span><span style="color:#b48ead;">let</span><span> library = device.makeDefaultLibrary()
</span><span>        </span><span style="color:#b48ead;">let</span><span> clearFunc = library?.makeFunction(name: </span><span style="color:#a3be8c;">&quot;clearScreen&quot;</span><span>)
</span><span>        </span><span style="color:#b48ead;">let</span><span> drawFunc = library?.makeFunction(name: </span><span style="color:#a3be8c;">&quot;drawParticles&quot;</span><span>)
</span><span>
</span><span>        do {
</span><span>            clearState = </span><span style="color:#b48ead;">try</span><span> device.makeComputePipelineState(function: clearFunc!)
</span><span>            drawState = </span><span style="color:#b48ead;">try</span><span> device.makeComputePipelineState(function: drawFunc!)
</span><span>        } catch </span><span style="color:#b48ead;">let</span><span> error as NSError {
</span><span>            print(error)
</span><span>        }
</span><span>
</span><span>        metalView.device = device
</span><span>        metalView.framebufferOnly = </span><span style="color:#b48ead;">false
</span><span>        metalView.delegate = </span><span style="color:#b48ead;">self
</span><span>
</span><span>        initializeBuffers()
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">func </span><span>initializeBuffers() {
</span><span>
</span><span>        </span><span style="color:#b48ead;">let</span><span> side = </span><span style="color:#d08770;">800
</span><span>        </span><span style="color:#b48ead;">var</span><span> particles: [Particle] = []
</span><span>
</span><span>        </span><span style="color:#b48ead;">for</span><span> _ </span><span style="color:#b48ead;">in </span><span style="color:#d08770;">0</span><span>..&lt;particleCount {
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> red = Float.random(</span><span style="color:#b48ead;">in</span><span>: </span><span style="color:#d08770;">0</span><span>...</span><span style="color:#d08770;">1</span><span>)
</span><span>            </span><span style="color:#b48ead;">let</span><span> green = Float.random(</span><span style="color:#b48ead;">in</span><span>: </span><span style="color:#d08770;">0</span><span>...</span><span style="color:#d08770;">1</span><span>)
</span><span>            </span><span style="color:#b48ead;">let</span><span> blue = Float.random(</span><span style="color:#b48ead;">in</span><span>: </span><span style="color:#d08770;">0</span><span>...</span><span style="color:#d08770;">1</span><span>)
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> x = Float(arc4random() %  UInt32(side))
</span><span>            </span><span style="color:#b48ead;">let</span><span> y = Float(arc4random() %  UInt32(side))
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> vx = (Float(arc4random() %  </span><span style="color:#d08770;">10</span><span>) - </span><span style="color:#d08770;">5</span><span>) / </span><span style="color:#d08770;">2
</span><span>            </span><span style="color:#b48ead;">let</span><span> vy = (Float(arc4random() %  </span><span style="color:#d08770;">10</span><span>) - </span><span style="color:#d08770;">5</span><span>) / </span><span style="color:#d08770;">2
</span><span>
</span><span>            </span><span style="color:#b48ead;">let</span><span> particle = Particle(
</span><span>                color: SIMD4&lt;Float&gt;(red, green, blue, </span><span style="color:#d08770;">1</span><span>),
</span><span>                position: SIMD2&lt;Float&gt;(x, y),
</span><span>                velocity: SIMD2&lt;Float&gt;(vx, vy))
</span><span>            particles.append(particle)
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#b48ead;">let</span><span> size = MemoryLayout&lt;Particle&gt;.stride * particleCount
</span><span>        particleBuffer = Renderer.device.makeBuffer(bytes: particles, length: size)
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">extension</span><span> Renderer: MTKViewDelegate {
</span><span>
</span><span>    </span><span style="color:#b48ead;">func </span><span>mtkView(_ view: MTKView, drawableSizeWillChange size: CGSize) { }
</span><span>
</span><span>    </span><span style="color:#b48ead;">func </span><span>draw(</span><span style="color:#b48ead;">in</span><span> view: MTKView) {
</span><span>        </span><span style="color:#b48ead;">guard let</span><span> drawable = view.currentDrawable </span><span style="color:#b48ead;">else</span><span> { </span><span style="color:#b48ead;">return </span><span>}
</span><span>
</span><span>        </span><span style="color:#b48ead;">let</span><span> commandbuffer = Renderer.commandQueue.makeCommandBuffer()
</span><span>        </span><span style="color:#b48ead;">let</span><span> commandEncoder = commandbuffer?.makeComputeCommandEncoder()
</span><span>
</span><span>        commandEncoder?.setComputePipelineState(clearState)
</span><span>        commandEncoder?.setTexture(drawable.texture, index: </span><span style="color:#d08770;">0</span><span>)
</span><span>
</span><span>        </span><span style="color:#b48ead;">let</span><span> w = clearState.threadExecutionWidth
</span><span>        </span><span style="color:#b48ead;">let</span><span> h = clearState.maxTotalThreadsPerThreadgroup / w
</span><span>
</span><span>        </span><span style="color:#b48ead;">var</span><span> threadsPerThreadGroup = MTLSize(width: w, height: h, depth: </span><span style="color:#d08770;">1</span><span>)
</span><span>        </span><span style="color:#b48ead;">var</span><span> threadsPerGrid = MTLSize(width: drawable.texture.width, height: drawable.texture.height, depth: </span><span style="color:#d08770;">1</span><span>)
</span><span>        commandEncoder?.dispatchThreads(threadsPerGrid, threadsPerThreadgroup: threadsPerThreadGroup)
</span><span>
</span><span>        commandEncoder?.setComputePipelineState(drawState)
</span><span>        commandEncoder?.setBuffer(particleBuffer, offset: </span><span style="color:#d08770;">0</span><span>, index: </span><span style="color:#d08770;">0</span><span>)
</span><span>        threadsPerGrid = MTLSize(width: particleCount, height: </span><span style="color:#d08770;">1</span><span>, depth: </span><span style="color:#d08770;">1</span><span>)
</span><span>        threadsPerThreadGroup = MTLSize(width: w, height: </span><span style="color:#d08770;">1</span><span>, depth: </span><span style="color:#d08770;">1</span><span>)
</span><span>        commandEncoder?.dispatchThreads(threadsPerGrid, threadsPerThreadgroup: threadsPerThreadGroup)
</span><span>
</span><span>        commandEncoder?.endEncoding()
</span><span>        commandbuffer?.present(drawable)
</span><span>        commandbuffer?.commit()
</span><span>    }
</span><span>}
</span></code></pre>
<p>The shader functions are defined in a Metal file along with a Particle struct. The clearScreen kernel function creates a black background for the Metal view. Behavior and drawing of the particles is handled by the drawParticles kernel function.</p>
<pre data-lang="cpp" style="background-color:#2b303b;color:#c0c5ce;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">metal_stdlib</span><span>&gt;
</span><span style="color:#b48ead;">using namespace</span><span> metal;
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Particle {
</span><span>    float4 color;
</span><span>    float2 position;
</span><span>    float2 velocity;
</span><span>};
</span><span>
</span><span>kernel </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">clearScreen </span><span>(
</span><span>                            texture2d&lt;half, access::write&gt; </span><span style="color:#bf616a;">output </span><span>[[</span><span style="color:#bf616a;">texture</span><span>(</span><span style="color:#d08770;">0</span><span>)]],
</span><span>                            uint2 </span><span style="color:#bf616a;">id </span><span>[[thread_position_in_grid]])
</span><span>{
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(</span><span style="color:#bf616a;">half4</span><span>(</span><span style="color:#d08770;">0</span><span>), id);
</span><span>}
</span><span>
</span><span>kernel </span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">drawParticles </span><span>(
</span><span>                           texture2d&lt;half, access::write&gt; </span><span style="color:#bf616a;">output </span><span>[[</span><span style="color:#bf616a;">texture</span><span>(</span><span style="color:#d08770;">0</span><span>)]],
</span><span>                           device Particle *</span><span style="color:#bf616a;">particles </span><span>[[</span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">0</span><span>)]],
</span><span>                           uint </span><span style="color:#bf616a;">id </span><span>[[thread_position_in_grid]])
</span><span>{
</span><span>    </span><span style="color:#b48ead;">float</span><span> width = output.</span><span style="color:#bf616a;">get_width</span><span>();
</span><span>    </span><span style="color:#b48ead;">float</span><span> height = output.</span><span style="color:#bf616a;">get_height</span><span>();
</span><span>
</span><span>    Particle particle = particles[id];
</span><span>    float2 position = particle.</span><span style="color:#bf616a;">position</span><span>;
</span><span>    float2 velocity = particle.</span><span style="color:#bf616a;">velocity</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">if </span><span>(position.</span><span style="color:#bf616a;">x </span><span>&lt; </span><span style="color:#d08770;">0 </span><span>|| position.</span><span style="color:#bf616a;">x </span><span>&gt; width) {
</span><span>        velocity.</span><span style="color:#bf616a;">x </span><span>*= -</span><span style="color:#d08770;">1</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">if </span><span>(position.</span><span style="color:#bf616a;">y </span><span>&lt; </span><span style="color:#d08770;">0 </span><span>|| position.</span><span style="color:#bf616a;">y </span><span>&gt; height) {
</span><span>        velocity.</span><span style="color:#bf616a;">y </span><span>*= -</span><span style="color:#d08770;">1</span><span>;
</span><span>    }
</span><span>
</span><span>    position += velocity;
</span><span>    particle.</span><span style="color:#bf616a;">position </span><span>= position;
</span><span>    particle.</span><span style="color:#bf616a;">velocity </span><span>= velocity;
</span><span>    particles[id] = particle;
</span><span>
</span><span>    half4 color = </span><span style="color:#bf616a;">half4</span><span>(particle.</span><span style="color:#bf616a;">color</span><span>.</span><span style="color:#bf616a;">r</span><span>, particle.</span><span style="color:#bf616a;">color</span><span>.</span><span style="color:#bf616a;">g</span><span>, particle.</span><span style="color:#bf616a;">color</span><span>.</span><span style="color:#bf616a;">b</span><span>, </span><span style="color:#d08770;">1</span><span>);
</span><span>    uint2 pos = </span><span style="color:#bf616a;">uint2</span><span>(position.</span><span style="color:#bf616a;">x</span><span>, position.</span><span style="color:#bf616a;">y</span><span>);
</span><span>
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>(-</span><span style="color:#d08770;">1</span><span>,  </span><span style="color:#d08770;">1</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>( </span><span style="color:#d08770;">0</span><span>,  </span><span style="color:#d08770;">1</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>( </span><span style="color:#d08770;">1</span><span>,  </span><span style="color:#d08770;">1</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>(-</span><span style="color:#d08770;">1</span><span>,  </span><span style="color:#d08770;">0</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>( </span><span style="color:#d08770;">1</span><span>,  </span><span style="color:#d08770;">0</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>(-</span><span style="color:#d08770;">1</span><span>, -</span><span style="color:#d08770;">1</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>( </span><span style="color:#d08770;">0</span><span>, -</span><span style="color:#d08770;">1</span><span>));
</span><span>    output.</span><span style="color:#bf616a;">write</span><span>(color, pos + </span><span style="color:#bf616a;">uint2</span><span>( </span><span style="color:#d08770;">1</span><span>, -</span><span style="color:#d08770;">1</span><span>));
</span><span>}
</span></code></pre>

</div>
</div>
<div class="row my-5">
<div class="col">
    <p class="text-center small my-5">
        <a href="https://gavinw.me/swift-macos/">Swift Programming for macOS</a> Â© 2023 <br>
        Built by <a href="https://gavinw.me">Gavin Wiggins</a>
    </p>
</div>
</div>

</div>
</body>
</html>